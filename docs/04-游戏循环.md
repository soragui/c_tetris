# 第 4 课：游戏循环 🔄

## 4.1 什么是游戏循环？

游戏循环是游戏的心脏，不断重复以下流程：

```
┌─────────────────┐
│   处理输入       │
│  (键盘控制)     │
└────────┬────────┘
         ↓
┌─────────────────┐
│   更新状态       │
│  (方块下落)     │
└────────┬────────┘
         ↓
┌─────────────────┐
│   渲染画面       │
│  (绘制方块)     │
└────────┬────────┘
         ↓
    继续循环？
```

## 4.2 代码实现

```c
// main.c
int main(void) {
    render_init();      // 初始化 ncurses
    Game* game = game_create();
    game_init(game);
    
    while (game->running) {
        // 1. 处理输入
        int key = input_get_key();
        if (key != ERR) {
            input_handle_game(game, key);
        }
        
        // 2. 更新游戏状态
        game_update(game);
        
        // 3. 渲染画面
        game_render(game);
        
        // 4. 控制速度
        napms(game->paused ? 100 : 50);
    }
    
    game_destroy(game);
    render_cleanup();
    return 0;
}
```

## 4.3 方块下落逻辑

```c
// game.c
void game_update(Game* game) {
    if (!game || game->paused || game->game_over) return;
    
    // 方块下落一格
    game->current.y++;
    
    // 检查碰撞
    if (board_check_collision(&game->board, &game->current)) {
        // 退回一格
        game->current.y--;
        
        // 锁定方块到游戏板
        board_lock_tetromino(&game->board, &game->current);
        
        // 检查并消除行
        int lines = board_clear_lines(&game->board);
        
        // 生成新方块
        game->current = game->next;
        tetromino_init(&game->next, random_tetromino());
        
        // 检查游戏结束
        if (board_check_collision(&game->board, &game->current)) {
            game->game_over = true;
        }
    }
}
```

## 4.4 速度控制

```c
// 初始速度：3 秒/格
game->drop_interval = 3000;

// 每升一级，速度加快 10%
game->drop_interval = game->drop_interval * 90 / 100;

// 最快速度：300ms/格
if (game->drop_interval < 300) game->drop_interval = 300;
```

## ✅ 本课检查清单

- [ ] 理解游戏循环的概念
- [ ] 掌握输入 - 更新 - 渲染流程
- [ ] 理解方块下落逻辑
- [ ] 知道如何控制游戏速度

---

下一课：[碰撞检测](06-碰撞检测.md)
