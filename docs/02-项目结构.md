# ç¬¬ 2 è¯¾ï¼šé¡¹ç›®ç»“æ„ ğŸ“

## 2.1 æœ¬è¯¾ç›®æ ‡

ç†è§£ C è¯­è¨€é¡¹ç›®çš„ç»„ç»‡æ–¹å¼ï¼Œå­¦ä¼šå¦‚ä½•è®¾è®¡åˆç†çš„æ–‡ä»¶ç»“æ„ã€‚

---

## 2.2 ä¸ºä»€ä¹ˆéœ€è¦è‰¯å¥½çš„é¡¹ç›®ç»“æ„ï¼Ÿ

### é—®é¢˜åœºæ™¯

æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä½ æŠŠæ‰€æœ‰çš„ä»£ç éƒ½æ”¾åœ¨ä¸€ä¸ªæ–‡ä»¶é‡Œï¼š

```c
// âŒ ç³Ÿç³•çš„åšæ³•ï¼šmain.c æœ‰ 2000 è¡Œ
#include <stdio.h>

// 100 è¡Œå˜é‡å®šä¹‰
// 500 è¡Œæ–¹å—é€»è¾‘
// 300 è¡Œç¢°æ’æ£€æµ‹
// 400 è¡Œæ¸²æŸ“ä»£ç 
// 200 è¡Œè¾“å…¥å¤„ç†
// 500 è¡Œæ¸¸æˆå¾ªç¯

int main() { ... }
```

**é—®é¢˜ï¼š**
- ğŸ” æ‰¾ä¸åˆ°éœ€è¦çš„ä»£ç 
- ğŸ› éš¾ä»¥å®šä½ bug
- ğŸ¤ æ— æ³•ä¸ä»–äººåä½œ
- ğŸ“¦ éš¾ä»¥å¤ç”¨ä»£ç 

### æ¨¡å—åŒ–è®¾è®¡çš„å¥½å¤„

```
âœ… æ¯ä¸ªæ–‡ä»¶è´Ÿè´£ä¸€ä¸ªåŠŸèƒ½
âœ… å¿«é€Ÿæ‰¾åˆ°éœ€è¦çš„ä»£ç 
âœ… å¤šäººå¯ä»¥å¹¶è¡Œå¼€å‘
âœ… ä»£ç å¯ä»¥åœ¨å…¶ä»–é¡¹ç›®å¤ç”¨
```

---

## 2.3 æˆ‘ä»¬çš„é¡¹ç›®ç»“æ„

```
tetris/
â”œâ”€â”€ src/                    # æºä»£ç ç›®å½•
â”‚   â”œâ”€â”€ main.c              # ç¨‹åºå…¥å£ï¼ˆçº¦ 80 è¡Œï¼‰
â”‚   â”œâ”€â”€ game.c/h            # æ¸¸æˆæ ¸å¿ƒé€»è¾‘ï¼ˆçº¦ 120 è¡Œï¼‰
â”‚   â”œâ”€â”€ board.c/h           # æ¸¸æˆæ¿ç®¡ç†ï¼ˆçº¦ 50 è¡Œï¼‰
â”‚   â”œâ”€â”€ tetromino.c/h       # æ–¹å—å®šä¹‰å’Œæ“ä½œï¼ˆçº¦ 110 è¡Œï¼‰
â”‚   â”œâ”€â”€ render.c/h          # ncurses æ¸²æŸ“ï¼ˆçº¦ 230 è¡Œï¼‰
â”‚   â”œâ”€â”€ input.c/h           # é”®ç›˜è¾“å…¥å¤„ç†ï¼ˆçº¦ 90 è¡Œï¼‰
â”‚   â””â”€â”€ score.c/h           # åˆ†æ•°å’Œæœ€é«˜åˆ†ï¼ˆçº¦ 130 è¡Œï¼‰
â”œâ”€â”€ docs/                   # æ•™ç¨‹æ–‡æ¡£
â”œâ”€â”€ data/                   # æ¸¸æˆæ•°æ®
â”‚   â””â”€â”€ highscores.txt      # æœ€é«˜åˆ†è®°å½•
â”œâ”€â”€ obj/                    # ç¼–è¯‘ä¸­é—´æ–‡ä»¶ï¼ˆè‡ªåŠ¨ç”Ÿæˆï¼‰
â”œâ”€â”€ Makefile                # æ„å»ºé…ç½®
â””â”€â”€ README.md               # é¡¹ç›®è¯´æ˜
```

---

## 2.4 æ–‡ä»¶å‘½åè§„åˆ™

### C è¯­è¨€æ–‡ä»¶ç±»å‹

| æ‰©å±•å | ç”¨é€” | å†…å®¹ |
|--------|------|------|
| `.c` | æºæ–‡ä»¶ | å‡½æ•°çš„**å®ç°**ï¼ˆå…·ä½“ä»£ç ï¼‰ |
| `.h` | å¤´æ–‡ä»¶ | å‡½æ•°çš„**å£°æ˜**ï¼ˆæ¥å£ï¼‰ |

### ä¸ºä»€ä¹ˆè¦åˆ† `.c` å’Œ `.h`ï¼Ÿ

**å¤´æ–‡ä»¶ï¼ˆ.hï¼‰- æ¥å£**
```c
// tetromino.h
#ifndef TETROMINO_H
#define TETROMINO_H

// å‘Šè¯‰ç¼–è¯‘å™¨ï¼šæœ‰è¿™ä¹ˆä¸€ä¸ªå‡½æ•°
void tetromino_init(Tetromino* t, TetrominoType type);

#endif
```

**æºæ–‡ä»¶ï¼ˆ.cï¼‰- å®ç°**
```c
// tetromino.c
#include "tetromino.h"

// å®é™…ä»£ç 
void tetromino_init(Tetromino* t, TetrominoType type) {
    t->type = type;
    t->x = BOARD_WIDTH / 2 - 2;
    t->y = 0;
    // ... å…·ä½“å®ç°
}
```

**å¥½å¤„ï¼š**
- å…¶ä»–æ–‡ä»¶åªéœ€åŒ…å« `.h` å°±èƒ½ä½¿ç”¨å‡½æ•°
- ä¸éœ€è¦çŸ¥é“å‡½æ•°å†…éƒ¨å¦‚ä½•å®ç°
- å®ç°å¯ä»¥ä¿®æ”¹ï¼Œåªè¦æ¥å£ä¸å˜

---

## 2.5 å„æ¨¡å—è¯¦ç»†èŒè´£

### main.c - ç¨‹åºå…¥å£

**èŒè´£ï¼š** åˆå§‹åŒ–ã€æ¸¸æˆä¸»å¾ªç¯ã€æ¸…ç†èµ„æº

```c
// main.c æ ¸å¿ƒç»“æ„
#include "game.h"
#include "render.h"
#include "input.h"

int main(void) {
    // 1. åˆå§‹åŒ–
    render_init();
    load_high_scores();
    
    Game* game = game_create();
    game_init(game);
    
    // 2. æ¸¸æˆä¸»å¾ªç¯
    while (game->running) {
        input_handle_game(game, input_get_key());
        game_update(game);
        game_render(game);
        napms(50);
    }
    
    // 3. æ¸…ç†
    game_destroy(game);
    render_cleanup();
    return 0;
}
```

**ä¸ºä»€ä¹ˆè¿™æ ·è®¾è®¡ï¼Ÿ**
- `main()` å‡½æ•°ä¿æŒç®€æ´
- å…·ä½“åŠŸèƒ½å§”æ‰˜ç»™å…¶ä»–æ¨¡å—
- æ˜“äºç†è§£å’Œç»´æŠ¤

---

### game.c/h - æ¸¸æˆæ ¸å¿ƒ

**èŒè´£ï¼š** æ¸¸æˆçŠ¶æ€ç®¡ç†ã€æ–¹å—ç”Ÿæˆã€æ¸¸æˆé€»è¾‘æ›´æ–°

```c
// game.h - å£°æ˜
typedef struct {
    Board board;           // æ¸¸æˆæ¿
    Tetromino current;     // å½“å‰æ–¹å—
    Tetromino next;        // ä¸‹ä¸€ä¸ªæ–¹å—
    Tetromino ghost;       // å½±å­æ–¹å—
    int score;
    int level;
    bool running;
    bool game_over;
} Game;

Game* game_create(void);
void game_init(Game* game);
void game_update(Game* game);
void game_calculate_ghost(Game* game);
```

**ä¸ºä»€ä¹ˆéœ€è¦ Game ç»“æ„ä½“ï¼Ÿ**
- æŠŠæ‰€æœ‰æ¸¸æˆçŠ¶æ€é›†ä¸­ç®¡ç†
- å‡½æ•°ä¹‹é—´å…±äº«æ•°æ®
- æ˜“äºä¿å­˜/åŠ è½½æ¸¸æˆ

---

### board.c/h - æ¸¸æˆæ¿

**èŒè´£ï¼š** ç®¡ç† 20x10 çš„æ¸¸æˆç½‘æ ¼ã€é”å®šæ–¹å—ã€æ¶ˆé™¤è¡Œ

```c
// board.h
#define BOARD_WIDTH   10
#define BOARD_HEIGHT  20

typedef struct {
    int cells[BOARD_HEIGHT][BOARD_WIDTH];
} Board;

void board_init(Board* board);
void board_lock_tetromino(Board* board, Tetromino* t);
int board_clear_lines(Board* board);
```

**ä¸ºä»€ä¹ˆç”¨äºŒç»´æ•°ç»„ï¼Ÿ**
```
cells[20][10] ç›´è§‚è¡¨ç¤ºæ¸¸æˆåŒºåŸŸï¼š

è¡Œ 0  [0][0] [0][1] ... [0][9]
è¡Œ 1  [1][0] [1][1] ... [1][9]
...
è¡Œ 19 [19][0] [19][1] ... [19][9]

- 0 è¡¨ç¤ºç©ºæ ¼
- 1-7 è¡¨ç¤ºä¸åŒé¢œè‰²çš„æ–¹å—
```

---

### tetromino.c/h - æ–¹å—

**èŒè´£ï¼š** æ–¹å—å®šä¹‰ã€ç§»åŠ¨ã€æ—‹è½¬

```c
// tetromino.h
typedef enum {
    TETRO_I, TETRO_O, TETRO_T, TETRO_S,
    TETRO_Z, TETRO_J, TETRO_L
} TetrominoType;

typedef struct {
    TetrominoType type;
    int x, y;           // ä½ç½®
    int shape[4][4];    // 4x4 å½¢çŠ¶çŸ©é˜µ
} Tetromino;

void tetromino_init(Tetromino* t, TetrominoType type);
void tetromino_rotate(Tetromino* t);
```

**ä¸ºä»€ä¹ˆç”¨ 4x4 çŸ©é˜µï¼Ÿ**
- æ‰€æœ‰ 7 ç§æ–¹å—éƒ½èƒ½æ”¾å…¥ 4x4 ç½‘æ ¼
- æ—‹è½¬æ“ä½œç®€å•ï¼ˆçŸ©é˜µæ—‹è½¬ï¼‰
- ç¢°æ’æ£€æµ‹æ–¹ä¾¿ï¼ˆéå† 16 ä¸ªæ ¼å­ï¼‰

---

### render.c/h - æ¸²æŸ“

**èŒè´£ï¼š** ä½¿ç”¨ ncurses ç»˜åˆ¶æ¸¸æˆç•Œé¢

```c
// render.h
void render_init(void);           // åˆå§‹åŒ– ncurses
void render_cleanup(void);        // æ¸…ç†
void render_game(Game* game);     // ç»˜åˆ¶æ•´ä¸ªæ¸¸æˆ
void render_ghost(Tetromino* t);  // ç»˜åˆ¶å½±å­
```

**ä¸ºä»€ä¹ˆå•ç‹¬åˆ†ç¦»æ¸²æŸ“æ¨¡å—ï¼Ÿ**
- å¦‚æœæƒ³æ¢å›¾å½¢åº“ï¼ˆå¦‚ SDL2ï¼‰ï¼Œåªä¿®æ”¹ render.c
- æ¸¸æˆé€»è¾‘ä¸å—å½±å“
- ç¬¦åˆ"å•ä¸€èŒè´£åŸåˆ™"

---

### input.c/h - è¾“å…¥å¤„ç†

**èŒè´£ï¼š** è¯»å–é”®ç›˜è¾“å…¥ã€è½¬æ¢ä¸ºæ¸¸æˆæ“ä½œ

```c
// input.h
void input_handle_game(Game* game, int key);
```

**ä¸ºä»€ä¹ˆéœ€è¦è¾“å…¥å¤„ç†æ¨¡å—ï¼Ÿ**
- é›†ä¸­ç®¡ç†æ‰€æœ‰æŒ‰é”®æ˜ å°„
- æ˜“äºä¿®æ”¹æ§åˆ¶æ–¹å¼
- å¯ä»¥æ·»åŠ è¾“å…¥ç¼“å†²ã€è¿å‡»æ£€æµ‹ç­‰

---

### score.c/h - è®¡åˆ†ç³»ç»Ÿ

**èŒè´£ï¼š** è®¡ç®—åˆ†æ•°ã€ç®¡ç†æœ€é«˜åˆ†è®°å½•

```c
// score.h
int score_calculate_lines(int lines, int level);
void save_high_score(const char* name, int score, ...);
void load_high_scores(void);
```

---

## 2.6 æ¨¡å—ä¾èµ–å…³ç³»

```
                    main.c
                      â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â†“            â†“            â†“
      game.c     render.c      input.c
         â”‚            â”‚            â”‚
    â”Œâ”€â”€â”€â”€â”´â”€â”€â”€â”€â”       â”‚            â”‚
    â†“         â†“       â”‚            â”‚
 board.c   tetromino.câ”‚            â”‚
    â”‚         â”‚       â”‚            â”‚
    â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜       â”‚            â”‚
         â†“            â†“            â†“
                  score.c
```

**ä¾èµ–è§„åˆ™ï¼š**
- `main.c` ä¾èµ–æ‰€æœ‰æ¨¡å—
- `game.c` ä¾èµ– `board.c` å’Œ `tetromino.c`
- åº•å±‚æ¨¡å—ï¼ˆboardã€tetrominoï¼‰ä¸ä¾èµ–ä¸Šå±‚æ¨¡å—

---

## 2.7 Makefile è¯¦è§£

```makefile
# 1. å®šä¹‰å˜é‡
CC = gcc
CFLAGS = -Wall -Wextra -std=c99 -Isrc -O2
LDFLAGS = -lncurses

# 2. æŸ¥æ‰¾æ‰€æœ‰æºæ–‡ä»¶
SRCS = $(wildcard src/*.c)
OBJS = $(SRCS:src/%.c=obj/%.o)

# 3. æœ€ç»ˆç›®æ ‡
tetris: $(OBJS)
	$(CC) $(OBJS) -o tetris $(LDFLAGS)

# 4. ç¼–è¯‘è§„åˆ™
obj/%.o: src/%.c
	$(CC) $(CFLAGS) -c $< -o $@

# 5. æ¸…ç†
clean:
	rm -rf obj/*.o tetris
```

**å…³é”®æ¦‚å¿µï¼š**

| è¯­æ³• | å«ä¹‰ |
|------|------|
| `$(VAR)` | å¼•ç”¨å˜é‡ |
| `$<` | ç¬¬ä¸€ä¸ªä¾èµ–æ–‡ä»¶ |
| `$@` | ç›®æ ‡æ–‡ä»¶ |
| `wildcard` | é€šé…ç¬¦åŒ¹é…æ–‡ä»¶ |

---

## 2.8 åŠ¨æ‰‹å®è·µ

### ç»ƒä¹  1ï¼šæŸ¥çœ‹ç¼–è¯‘è¿‡ç¨‹

```bash
# æŸ¥çœ‹è¯¦ç»†ç¼–è¯‘è¿‡ç¨‹
make clean
make -n  # -n è¡¨ç¤ºåªæ˜¾ç¤ºå‘½ä»¤ï¼Œä¸æ‰§è¡Œ
```

### ç»ƒä¹  2ï¼šæ·»åŠ è°ƒè¯•è¾“å‡º

```bash
# åœ¨ main.c çš„ main() å‡½æ•°å¼€å¤´æ·»åŠ ï¼š
printf("æ¸¸æˆå¯åŠ¨ï¼\n");

# é‡æ–°ç¼–è¯‘è¿è¡Œ
make
make run
```

### ç»ƒä¹  3ï¼šç»Ÿè®¡ä»£ç è¡Œæ•°

```bash
# ç»Ÿè®¡æ‰€æœ‰ .c æ–‡ä»¶çš„è¡Œæ•°
wc -l src/*.c

# è¾“å‡ºç¤ºä¾‹ï¼š
   80 src/main.c
  120 src/game.c
   ...
  900 total
```

---

## âœ… æœ¬è¯¾æ£€æŸ¥æ¸…å•

- [ ] ç†è§£é¡¹ç›®ç›®å½•ç»“æ„
- [ ] çŸ¥é“æ¯ä¸ªæ¨¡å—çš„èŒè´£
- [ ] ç†è§£ `.c` å’Œ `.h` çš„åŒºåˆ«
- [ ] ç†è§£ Makefile çš„ä½œç”¨
- [ ] çŸ¥é“æ¨¡å—ä¹‹é—´çš„ä¾èµ–å…³ç³»

---

## ğŸ“ å°ä½œä¸š

1. æ‰“å¼€ `src/game.h`ï¼Œæ‰¾å‡º `Game` ç»“æ„ä½“æœ‰å“ªäº›æˆå‘˜

2. åœ¨ `src/` ç›®å½•ä¸­ï¼Œå“ªä¸ªæ–‡ä»¶è´Ÿè´£ç»˜åˆ¶æ¸¸æˆç•Œé¢ï¼Ÿ

3. å¦‚æœè¦æ·»åŠ "éŸ³æ•ˆ"åŠŸèƒ½ï¼Œåº”è¯¥åˆ›å»ºä»€ä¹ˆæ–‡ä»¶ï¼Ÿæ”¾åœ¨å“ªé‡Œï¼Ÿ

---

ä¸‹ä¸€è¯¾ï¼š[æ•°æ®ç»“æ„](03-æ•°æ®ç»“æ„.md)
